<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SGP AUDIT v19.5 | MCR Controle Crítico</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { audit: { 500: '#059669', 600: '#047857', 700: '#065f46', 900: '#022c22' } } }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .timer-glow { text-shadow: 0 0 15px rgba(5, 150, 105, 0.3); }
        input, textarea { text-transform: uppercase; }
        .screen-fade { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // CONFIGURAÇÕES GLOBAIS DE SEGURANÇA
        const TARGET_EMAIL = "thyego.engflorestalmcr@gmail.com";
        const ZIP_PASSWORD = "MCR06032025";
        const GOOGLE_SCRIPT_URL = "SUA_URL_DO_GOOGLE_APPS_SCRIPT_AQUI"; 

        const TIPOS_PODA_DATA = [
            { id: "Poda de Levantamento" }, { id: "Poda de Limpeza" }, { id: "Poda de Adequação" }, 
            { id: "Poda Estrutural" }, { id: "Poda de Segurança" }, { id: "Poda Emergencial" }, { id: "CORTE TOTAL (SUPRESSÃO)" }
        ];

        const FONTES_DEMANDA = [
            { id: "manutencao", label: "Manutenção de Rotina" },
            { id: "os", label: "Poda com Protocolo (Cidadão)" },
            { id: "emergencia", label: "Emergência / Sinistro" },
            { id: "corte_protocolo", label: "Corte com Protocolo/Laudo" }
        ];

        // LISTA INTEGRAL DE ESPÉCIES
        const LISTA_ESPECIES = [
            "Araucária (Pinheiro-do-paraná) [AMEAÇADA / IMUNE]", "Cedro [AMEAÇADA]", "Imbuia [AMEAÇADA / IMUNE]", 
            "Peroba-rosa [AMEAÇADA]", "Canela-preta [AMEAÇADA]", "Jacarandá-da-bahia [AMEAÇADA]", "Pau-brasil [AMEAÇADA]",
            "Xaxim [AMEAÇADA / IMUNE]", "Figueira-branca [IMUNE]", "NÃO IDENTIFICADA", "DESCONHECIDA", "Abacateiro", 
            "Abacaxi-de-anta", "Acacia", "Acacia-negra", "Açaí", "Açoita-cavalo", "Alecrim", "Alecrim-de-campinas", 
            "Alfeneiro", "Algodoeiro", "Amapá", "Amendoim-bravo", "Angico", "Angico-branco", "Angico-vermelho", 
            "Araticum", "Aroeira", "Aroeira-mansa", "Aroeira-pimenteira", "Aroeira-preta", "Aroeira-salsa", 
            "Aroeira-vermelha", "Arvore-de-espeto", "Baguaçu", "Bambu", "Bauhinia", "Bicuíba", "Boleira", 
            "Bracatinga", "Braúna", "Buriti", "Cabreúva", "Cafezeiro", "Caixeta", "Cajueiro", "Cambará", "Camboatá", 
            "Canafístula", "Canela", "Canela-amarela", "Canela-batalha", "Canela-fogo", "Canela-guaicá", 
            "Canela-lageana", "Canjerana", "Capororoca", "Caroba", "Carvalho", "Casca-d'anta", "Castanha-do-maranhão", 
            "Casuarina", "Cedrinho", "Cerejeira", "Chapéu-de-napoleão", "Cinamomo", "Cipó-mil-homens", "Coqueiro", 
            "Corticeira", "Cumaru", "Cuveiro", "Embaúba", "Erva-mate", "Eucalipto", "Extremosa", "Ficus", 
            "Ficus-benjamina", "Figueira", "Flamboyant", "Gameleira", "Goiabeira", "Grápia", "Grevillea", 
            "Guabiroba", "Guaçatonga", "Guajuvira", "Guatambu", "Guatambu-branco", "Hovenia", "Ingá", "Ipê-amarelo", 
            "Ipê-branco", "Ipê-rosa", "Ipê-roxo", "Ipê-tabaco", "Jabuticabeira", "Jabuticaba", "Jacarandá", "Jacarandá-mimoso", 
            "Jacarandá-paulista", "Jaca", "Jamelão", "Jatobá", "Jequitibá", "Jerivá", "Leiteiro", "Ligustro", 
            "Louro", "Louro-pardo", "Magnólia", "Mamica-de-cadela", "Mandioqueira", "Mangueira", "Marinheiro", 
            "Mogno", "Monjoleiro", "Mulungu", "Murta", "Noz-pecã", "Oiti", "Oleo-balsamo", "Paineira", 
            "Palmeira-imperial", "Palmeira-real", "Pata-de-vaca", "Pau-ferro", "Pau-marfim", "Pau-mulato", 
            "Peroba", "Pinus", "Pitanga", "Platano", "Quaresmeira", "Resedá", "Sabiá", "Sagüeiro", "Sangra-d'água", 
            "Sapucaia", "Sete-copas", "Sibipiruna", "Sucupira", "Tamarineiro", "Tarumã", "Tipuana", "Tucaneira", 
            "Uvaia", "Uva-do-japão", "Vassourão-branco"
        ].sort();

        const PAUSE_REASONS = ["Almoço / Refeição", "Chuva / Tempo Ruim", "Quebra de Equipamento", "Logística / Deslocamento", "Interferência de Munícipe", "Abastecimento", "Suspensão Rede (COPEL)", "Outros"];

        const formatDuration = (totalSeconds) => {
            const s = Math.max(0, totalSeconds);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        };

        // COMPONENTES DE UI
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-200 p-5 mb-4 ${className}`}>{children}</div>
        );

        const Label = ({ children, required }) => (
            <label className="block text-[11px] font-bold text-slate-500 uppercase mb-1.5 tracking-wider">
                {children} {required && <span className="text-red-500">*</span>}
            </label>
        );

        const PhotoUpload = ({ label, help, preview, onCapture, icon="fa-camera", fullWidth = false }) => (
            <label className={`relative ${fullWidth ? 'h-40' : 'h-28'} border-2 border-dashed rounded-xl flex flex-col items-center justify-center transition-all cursor-pointer ${preview ? 'border-audit-500 bg-emerald-50' : 'border-slate-300 bg-slate-50'}`}>
                {preview ? <img src={preview} className="absolute inset-0 w-full h-full object-cover rounded-xl" /> : (
                    <div className="text-center p-2">
                        <i className={`fas ${icon} text-2xl text-slate-300 mb-1`}></i>
                        <div className="text-[9px] font-black text-slate-600 uppercase leading-tight">{label}</div>
                    </div>
                )}
                <input type="file" className="hidden" accept="image/*" onChange={e => onCapture(e.target.files[0])} />
            </label>
        );

        const App = () => {
            const [view, setView] = useState('loading');
            const [shift, setShift] = useState({ rt: '', tst: '', operador: '', placa: '', auxiliares: [''], active: false });
            const [activeAction, setActiveAction] = useState(null);
            const [logs, setLogs] = useState([]);
            const [gps, setGps] = useState({ lat: null, lng: null });
            const [elapsed, setElapsed] = useState(0); 
            const [journeyElapsed, setJourneyElapsed] = useState(0);

            // 1. EXTRAÇÃO DE METADADOS (BLINDAGEM)
            const extractExif = (file) => {
                return new Promise((resolve) => {
                    EXIF.getData(file, function() {
                        const date = EXIF.getTag(this, "DateTimeOriginal");
                        const lat = EXIF.getTag(this, "GPSLatitude");
                        const lon = EXIF.getTag(this, "GPSLongitude");
                        const toDec = (n, ref) => {
                            if(!n) return null;
                            let d = n[0].numerator/n[0].denominator + (n[1].numerator/n[1].denominator)/60 + (n[2].numerator/n[2].denominator)/3600;
                            return (ref === "S" || ref === "W") ? d * -1 : d;
                        };
                        resolve({
                            exifDate: date,
                            exifLat: toDec(lat, EXIF.getTag(this, "GPSLatitudeRef")),
                            exifLon: toDec(lon, EXIF.getTag(this, "GPSLongitudeRef"))
                        });
                    });
                });
            };

            // 2. SINCRONIZAÇÃO AUTOMÁTICA (OFFLINE-FIRST)
            const autoSync = async (payload) => {
                if (!navigator.onLine || GOOGLE_SCRIPT_URL.includes("SUA_URL")) return;
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ ...payload, timestamp: new Date().toISOString(), operator: shift.operador })
                    });
                } catch (e) { console.log("Offline: Dados em fila local."); }
            };

            useEffect(() => {
                const load = async () => {
                    const s = await idbKeyval.get('mcr_shift_v19');
                    const l = await idbKeyval.get('mcr_logs_v19') || [];
                    if (s) setShift(s);
                    setLogs(l);
                    setView(s?.active ? 'dashboard' : 'setup');
                };
                load();
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    if (shift?.active && shift?.journeyStartTime) setJourneyElapsed(Math.floor((Date.now() - shift.journeyStartTime) / 1000));
                    if (activeAction?.startTime) setElapsed(Math.floor((Date.now() - activeAction.startTime) / 1000));
                }, 1000);
                return () => clearInterval(timer);
            }, [activeAction, shift.active]);

            useEffect(() => {
                const watchId = navigator.geolocation.watchPosition(
                    (pos) => setGps({ lat: pos.coords.latitude.toFixed(6), lng: pos.coords.longitude.toFixed(6) }),
                    null, { enableHighAccuracy: true }
                );
                return () => navigator.geolocation.clearWatch(watchId);
            }, []);

            const processPhoto = async (file) => {
                if (!file) return null;
                const metadata = await extractExif(file);
                const options = { maxSizeMB: 0.1, maxWidthOrHeight: 1024, useWebWorker: true, preserveExif: true };
                try {
                    const compressed = await imageCompression(file, options);
                    return new Promise(r => {
                        const reader = new FileReader();
                        reader.readAsDataURL(compressed);
                        reader.onloadend = () => {
                            const data = reader.result;
                            // Telemetria: Envia metadados assim que a foto é processada
                            autoSync({ type: 'TELEMETRY_PHOTO', metadata, gps_now: gps });
                            r(data);
                        };
                    });
                } catch (e) { return null; }
            };

            // TELAS (CONFORME ORIGINAL)
            if (view === 'setup') return (
                <div className="p-6 screen-fade pb-20 no-scrollbar">
                    <div className="text-center mb-8"><i className="fas fa-helmet-safety text-audit-600 text-5xl mb-4"></i><h1 className="text-2xl font-black text-slate-800 uppercase">Abertura de Turno</h1></div>
                    <Card>
                        <Label required>Encarregado</Label>
                        <input className="w-full p-4 border-2 rounded-2xl font-black uppercase text-sm" value={shift.operador} onChange={e => setShift({...shift, operador: e.target.value.toUpperCase()})} />
                        <Label required className="mt-4">Placa Munk</Label>
                        <input className="w-full p-4 border-2 rounded-2xl font-black uppercase text-sm" value={shift.placa} onChange={e => setShift({...shift, placa: e.target.value.toUpperCase()})} />
                    </Card>
                    <Card><Label required>DDS / Checklist</Label><PhotoUpload fullWidth label="DDS + CHECKLIST" preview={shift.foto_dds} onCapture={async f => setShift({...shift, foto_dds: await processPhoto(f)})} /></Card>
                    <button disabled={!shift.operador || !shift.placa || !shift.foto_dds} onClick={() => { setShift({...shift, active: true, journeyStartTime: Date.now()}); setView('dashboard'); idbKeyval.set('mcr_shift_v19', {...shift, active: true, journeyStartTime: Date.now()}); }} className="w-full py-6 bg-audit-600 text-white rounded-3xl font-black text-xl uppercase shadow-xl">Iniciar Expediente</button>
                </div>
            );

            if (view === 'dashboard') return (
                <div className="screen-fade pb-24 min-h-screen no-scrollbar">
                    <div className="p-4 border-b flex justify-between items-center bg-white sticky top-0 z-40 shadow-sm">
                        <div className="flex items-center gap-3"><div className="w-10 h-10 bg-audit-600 rounded-full flex items-center justify-center text-white"><i className="fas fa-tree"></i></div><div><p className="text-[10px] font-black text-audit-600 uppercase leading-none">Gestão MCR</p><p className="font-black text-slate-800 text-sm uppercase mt-1.5">{shift.operador}</p></div></div>
                    </div>
                    <div className="p-5">
                        <div className="bg-slate-900 p-6 rounded-3xl text-white shadow-2xl mb-4 text-center border-b-4 border-audit-500">
                            <p className="text-[10px] font-black opacity-50 uppercase mb-1">Jornada Total Diária</p>
                            <p className="text-4xl font-black font-mono text-audit-500 tracking-tighter">{formatDuration(journeyElapsed)}</p>
                        </div>
                        <button onClick={() => { setActiveAction({ pruningTypes: [], status: 'OK', photosBefore: [], photosAfter: [], startTime: Date.now() }); setView('tree_form'); }} className="w-full bg-audit-600 text-white p-9 rounded-[2rem] shadow-xl flex flex-col items-center gap-2 mb-4"><i className="fas fa-plus-circle text-3xl"></i><span className="font-black text-xl uppercase">Registrar Manejo</span></button>
                        <button onClick={() => setView('pause_form')} className="w-full bg-white border-2 border-slate-200 p-6 rounded-3xl text-slate-600 font-black uppercase">Registrar Parada</button>
                    </div>
                </div>
            );

            if (view === 'tree_form') return (
                <div className="p-6 screen-fade pb-20 no-scrollbar">
                    <h2 className="text-xl font-black text-slate-800 mb-6 uppercase italic">Prontuário</h2>
                    <Card>
                        <Label required>Espécie</Label>
                        <input list="especies" className="w-full p-4 border-2 rounded-2xl bg-slate-50 font-black text-sm uppercase" value={activeAction.species || ''} onChange={e => { setActiveAction({...activeAction, species: e.target.value.toUpperCase()}); autoSync({type: 'FIELD_UPDATE', species: e.target.value}); }} />
                        <datalist id="especies">{LISTA_ESPECIES.map(s => <option key={s} value={s} />)}</datalist>
                        <div className="grid grid-cols-2 gap-4 mt-4">
                            <div><Label required>CAP (cm)</Label><input type="number" className="w-full p-4 border-2 rounded-2xl font-black text-sm" value={activeAction.cap || ''} onChange={e => setActiveAction({...activeAction, cap: e.target.value})} /></div>
                            <div><Label required>Altura (m)</Label><input type="number" className="w-full p-4 border-2 rounded-2xl font-black text-sm" value={activeAction.height || ''} onChange={e => setActiveAction({...activeAction, height: e.target.value})} /></div>
                        </div>
                    </Card>
                    <Card>
                        <Label required>3 Fotos de Antes</Label>
                        <div className="grid grid-cols-3 gap-2">
                            <PhotoUpload label="F1" preview={activeAction.photosBefore[0]} onCapture={async f => { let l = [...activeAction.photosBefore]; l[0] = await processPhoto(f); setActiveAction({...activeAction, photosBefore: l}); }} />
                            <PhotoUpload label="F2" preview={activeAction.photosBefore[1]} onCapture={async f => { let l = [...activeAction.photosBefore]; l[1] = await processPhoto(f); setActiveAction({...activeAction, photosBefore: l}); }} />
                            <PhotoUpload label="F3" preview={activeAction.photosBefore[2]} onCapture={async f => { let l = [...activeAction.photosBefore]; l[2] = await processPhoto(f); setActiveAction({...activeAction, photosBefore: l}); }} />
                        </div>
                    </Card>
                    <button disabled={!activeAction.species || !activeAction.cap || activeAction.photosBefore.filter(p=>p).length < 3} onClick={() => { setActiveAction({...activeAction, executionStartTime: Date.now(), formDurationSec: elapsed}); setView('active_service'); }} className="w-full py-6 bg-audit-600 text-white rounded-3xl font-black uppercase text-xl shadow-lg">Iniciar Manejo Técnico</button>
                </div>
            );

            // TELA DE EXECUÇÃO (PARA MEDIÇÃO DE HM EFETIVA)
            if (view === 'active_service') return (
                <div className="p-6 screen-fade flex flex-col min-h-screen no-scrollbar">
                    <div className="text-center mt-6"><span className="bg-audit-600 text-white px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest">Execução em Curso</span><h2 className="text-xl font-black text-slate-800 uppercase mt-5">{activeAction.species}</h2></div>
                    <div className="flex-1 flex flex-col justify-center items-center">
                        <div className="text-7xl font-black text-slate-900 timer-glow font-mono tracking-tighter">{formatDuration(elapsed)}</div>
                        <p className="text-slate-400 font-black text-[11px] mt-2 uppercase tracking-widest">Tempo Efetivo</p>
                    </div>
                    <Card className="mt-auto border-2 border-audit-900 shadow-xl">
                        <Label required>3 Fotos de Depois</Label>
                        <div className="grid grid-cols-3 gap-2">
                            <PhotoUpload label="F1" preview={activeAction.photosAfter[0]} onCapture={async f => { let l = [...activeAction.photosAfter]; l[0] = await processPhoto(f); setActiveAction({...activeAction, photosAfter: l}); }} />
                            <PhotoUpload label="F2" preview={activeAction.photosAfter[1]} onCapture={async f => { let l = [...activeAction.photosAfter]; l[1] = await processPhoto(f); setActiveAction({...activeAction, photosAfter: l}); }} />
                            <PhotoUpload label="F3" preview={activeAction.photosAfter[2]} onCapture={async f => { let l = [...activeAction.photosAfter]; l[2] = await processPhoto(f); setActiveAction({...activeAction, photosAfter: l}); }} />
                        </div>
                        <button disabled={activeAction.photosAfter.filter(p=>p).length < 3} onClick={() => { 
                            const end = Date.now();
                            const log = { ...activeAction, endTime: end, durationSec: elapsed, coords: `${gps.lat},${gps.lng}` };
                            setLogs([log, ...logs]); 
                            autoSync({ type: 'COMPLETE_MANEJO', ...log });
                            setActiveAction(null); setView('dashboard'); 
                        }} className="w-full mt-4 py-5 rounded-2xl bg-audit-900 text-white font-black uppercase">Finalizar e Salvar</button>
                    </Card>
                </div>
            );

            if (view === 'loading') return <div className="h-screen bg-audit-900 flex items-center justify-center text-white font-black animate-pulse uppercase tracking-widest italic text-lg">Iniciando SGP AUDIT v19.5...</div>;
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>